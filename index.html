<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>My Tools</title>
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="toast/toast.style.css" rel="stylesheet">
    
    <!-- Custom styles for this template -->
    <link href="styles.css" rel="stylesheet">
  </head>

  <body>
    <input id="linkToCopy" value="" style="position: absolute; z-index: -999; opacity: 0;" />
    <div class="h-100 p-3 mx-auto flex-column">
      <header class="masthead mb-auto">
        <div class="row col-md-12">
            <button type="button" class="btn btn-primary mr-2" data-toggle="collapse" href="#render-branch-name" role="button" aria-expanded="true" aria-controls="render-branch-name">Render branch name</button>
            <button type="button" class="btn btn-primary mr-2" data-toggle="collapse" href="#reminder" role="button" aria-expanded="true" aria-controls="reminder">Reminder</button>
        </div>
      </header>
        
      <div class="row col-md-12 mt-2 text-left collapse show" id="render-branch-name">
          <div class="row col-md-12">  
            <div class="inner cover col-md-3">
              <label for="user" class="cover-heading hight-light-label">User Id</label>
              <input type="text" class="form-control" value="PPH011" id="user" placeholder="User Id">
            </div>
            
            <div class="inner cover col-md-2">
              <label for="sprintString" class="cover-heading hight-light-label">Sprint</label>
              <input type="text" class="form-control" id="sprintString" placeholder="Sprint">
            </div>
          </div>
          <div class="row col-md-12">  
            <div class="inner cover col-md-3">
              <label for="type" class="cover-heading hight-light-label">Type</label>
              <select id="type" class="form-control" aria-label="Default select example">
                <option value="features">Feature</option>
                <option value="bugs">Bug</option>
              </select>
            </div>
            <div class="inner cover col-md-9">
              <label for="inputString" class="cover-heading hight-light-label">Task/bug name</label>
              <input type="text" class="form-control" id="inputString" onchange="handleChange()" placeholder="Enter your task/bug name">
            </div>
          </div>
          
          <div class="row col-md-12"> 
            <div class="inner cover col-md-3">
            </div>
            <div class="inner cover col-md-8">
              <label class="cover-heading hight-light-label"></label>
              <label id="outputString" class="form-control">
            </div>
            <div class="inner cover col-md-1">
              <label class="cover-heading hight-light-label"></label>
              <button type="button" class="btn btn-light" onclick="copy()">Copy</button>
            </div>
          </div>
      </div>
        
      <div class="row col-md-12 mt-2 text-left collapse" id="reminder">
          <div class="row col-md-12">  
            <div class="inner cover col-md-1">
              <label for="addRow" class="cover-heading hight-light-label"></label>
              <button id="addRow" class="btn btn-light mr-2">Add</button>
            </div>
            <div class="inner cover col-md-1">
              <label for="checkbox" class="cover-heading hight-light-label">Repeat ?</label>
              <input type="checkbox" id="checkbox" class="form-control" checked>
            </div>
            <div class="inner cover col-md-1">
              <label for="repeatAfter" class="cover-heading hight-light-label">Mins</label>
              <input type="number" id="repeatAfter" class="form-control" min="0" value="3" >
            </div>
            <div class="inner cover col-md-1">
              <label for="times" class="cover-heading hight-light-label">Times</label>
              <input type="number" id="times" class="form-control" min="" value="3">
            </div>
            <div class="inner cover col-md-12">
              <audio id="reminderSound" src="Soft-high-tech-notification-sound-effect.mp3" preload="auto"></audio>
              <table id="reminderTable">
                <tr>
                  <th>Time</th>
                  <th style="width: 1000px;">Message</th>
                  <th>Actions</th>
                </tr>
              </table>
            </div>
          </div>
      </div>
      <footer class="mastfoot mt-auto">
      </footer>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster --><script
  src="https://code.jquery.com/jquery-3.6.0.min.js"  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="  crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script src="toast/toast.script.js"></script>
  <script>
    let timeout;
    let hideInput = '#linkToCopy';
    const regex = new RegExp(/[^a-zA-Z0-9#]/g);
    function handleChange() {
      if(timeout){
        clearTimeout(timeout);
      }
      
      timeout = setTimeout(() => {
        generate();
      }, 300)
    }
    function generate(){
      let inputString = $('#inputString').val().trim();
      let sprint = $('#sprintString').val().trim();
      let user = $('#user').val().trim();
      let text = 'Sprint' + sprint + '/' + user + '/' + inputString;
      if(!text){
        return;
      }
      
      let value = getBranchName(text);
      
      value = keep1Underscore(value);
      setValueToHideInput(value);
      $('#outputString').text(value);
      copy();
    }

    function copy()
    {
      copyToClipboard();
      copiedToast($(hideInput).val());
    }
    function getBranchName(text){
      text = $('#type').val() + '/' + text.replace(regex, '_');
      return text;
    }

    function keep1Underscore(text){
      return text.replace(new RegExp(/[_]{2,}/g), '_');
    }


    function setValueToHideInput(value){
      $(hideInput).val(value);
    }

    function copyToClipboard(){
        $(hideInput).select();      
        document.execCommand("copy");
    }

    function copiedToast(value){
      successToast("Copied", value);
    }

    function successToast(title, value){
      $.Toast(title, value, "success", {
              has_icon:true,
              has_close_btn:true,
        stack: true,
              fullscreen:false,
              timeout:4000,
              sticky:false,
              has_progress:true,
              rtl:false,
        });
    }
  </script>

  <script>
    Notification.requestPermission();

    const table = document.getElementById("reminderTable");

    // State management
    const reminders = []; 
    let reminderCounter = 0;

    function addRow() {
      const id = reminderCounter++;

      const tr = document.createElement("tr");
      tr.dataset.id = id;

      tr.innerHTML = `
        <td><input type="datetime-local" class="time form-control"></td>
        <td><input type="text" width="500px" class="msg form-control" placeholder="Reminder message..."></td>
        <td>
          <button class="addBtn btn btn-sm btn-light">Add</button>
          <button class="removeBtn btn btn-sm btn-light">Remove</button>
        </td>
      `;

      const addBtn = tr.querySelector(".addBtn");
      const removeBtn = tr.querySelector(".removeBtn");

      addBtn.addEventListener("click", () => activateReminder(id, tr));
      removeBtn.addEventListener("click", () => removeReminders(id, tr));

      table.appendChild(tr);
    }

    function activateReminder(id, tr) {
      const time = tr.querySelector(".time").value;
      const msg = tr.querySelector(".msg").value;

      if (!time || !msg) {
        alert("Please fill in both time and message.");
        return;
      }

      let target = new Date(time);
      const targetTicks = target.getTime();
      const now = new Date();
      const nowTicks = now.getTime()

      if (targetTicks <= nowTicks) {
        alert("Time must be in the future.");
        return;
      }
      let mins = $('#checkbox').val() === 'on' ? $('#repeatAfter').val() * 1 : 0;
      let times =$('#checkbox').val() === 'on' ? $('#times').val() * 1 : 0;
      for(let i = 0; i < 1 + times; i++){
        let newMin = i * mins;
        let cloneTime = new Date(target);
        cloneTime.setMinutes(cloneTime.getMinutes() + newMin);
        
        const timeout = cloneTime.getTime() - now;

        const timeoutId = setTimeout(() => {
          new Notification("Reminder", { body: msg });
          reminders[id].active = false;
          const audio = document.getElementById("reminderSound");
          audio.currentTime = 0; // reset
          audio.volume = 0.3;
          audio.play();
          removeReminder(id, tr, timeoutId);
        }, timeout);
        if(!reminders[id]){
          reminders[id] = [];
        }
        reminders[id].push({
          id: id,
          active: true,
          timeoutId: timeoutId,
          message: msg,
          time: time,
        });
      }

      tr.classList.add("active");
      tr.querySelector(".addBtn").disabled = true;
    }

    function removeReminders(id, tr) {
      const r = reminders[id].filter(d => d.id == id);
      for(let d of r) {
        if(d.active){
          clearTimeout(d.timeoutId);
          d.active = false;
        }
      }
      if(reminders[id].filter(d => d.id == id && d.active).length == 0){
        tr.classList.add("removed");
        tr.querySelector(".addBtn").disabled = true;
        tr.querySelector(".removeBtn").disabled = true;
      }
    }

    function removeReminder(id, tr, timeoutId) {
      const r = reminders[id].filter(d => d.id == id && d.timeoutId == timeoutId);
      for(let d of r) {
        if(d.active){
          clearTimeout(d.timeoutId);
          d.active = false;
        }
      }
      if(reminders[id].filter(d => d.id == id && d.active).length == 0){
        tr.classList.add("removed");
        tr.querySelector(".addBtn").disabled = true;
        tr.querySelector(".removeBtn").disabled = true;
      }
    }

    // Prevent closing tab if any active reminders
    window.addEventListener("beforeunload", (e) => {
      const hasActive = reminders.flat(1).some(r => r && r.active);
      if (hasActive) {
        e.preventDefault();
        e.returnValue = "";
      }
    });

    // Add initial row
    document.getElementById("addRow").addEventListener("click", addRow);
    addRow();
  </script>
</body>
</html>
